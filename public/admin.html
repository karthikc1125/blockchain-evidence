<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ‘‘ Admin Dashboard - EVID-DGC</title>
    <link rel="stylesheet" href="styles.css">
    <style>
        .admin-section { margin: 30px 0; }
        .user-table { width: 100%; border-collapse: collapse; margin: 20px 0; }
        .user-table th, .user-table td { padding: 12px; border: 1px solid var(--border-light); text-align: left; }
        .user-table th { background: var(--light-gray); font-weight: 600; }
        .test-account { background: #fff3cd; }
        .inactive-user { background: #f8d7da; opacity: 0.7; }
        .copy-btn { padding: 4px 8px; font-size: 0.8rem; margin-left: 8px; }
        .admin-form { background: var(--light-gray); padding: 20px; border-radius: 8px; margin: 20px 0; }
        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .test-wallet { font-family: monospace; font-size: 0.9rem; }
    </style>
</head>
<body>
    <nav class="dashboard-nav">
        <div class="container">
            <div class="nav-content">
                <a href="index.html" class="nav-brand">ğŸ” EVID-DGC Admin</a>
                <div class="nav-items">
                    <span class="badge badge-admin">Administrator</span>
                    <span id="adminWallet" class="wallet-display">Loading...</span>
                    <button class="btn btn-outline btn-sm" onclick="logout()">ğŸšª Logout</button>
                </div>
            </div>
        </div>
    </nav>

    <div class="container">
        <!-- Admin Dashboard Hero -->
        <div class="dashboard-hero">
            <h1>ğŸ‘‘ Administrator Dashboard</h1>
            <p>Manage users, create test accounts, and oversee system operations</p>
        </div>

        <!-- Create Admin Section -->
        <div class="admin-section card">
            <div class="card-header">
                <h2>â• Create New Administrator</h2>
                <p>Add a new administrator account (Max: 10 admins)</p>
            </div>
            <div class="card-body">
                <form id="createAdminForm" class="admin-form">
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="adminWalletAddress">ğŸ‘¤ Wallet Address *</label>
                            <input type="text" id="adminWalletAddress" class="form-control" 
                                   placeholder="0x..." required>
                        </div>
                        <div class="form-group">
                            <label for="adminFullName">ğŸ“ Full Name *</label>
                            <input type="text" id="adminFullName" class="form-control" 
                                   placeholder="Enter full name" required>
                        </div>
                    </div>
                    <div class="form-actions">
                        <button type="submit" class="btn btn-primary">
                            âœ… Create Administrator
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Test Accounts Section -->
        <div class="admin-section card">
            <div class="card-header">
                <h2>ğŸ§ª Test Accounts</h2>
                <p>Create test accounts for role testing without multiple MetaMask wallets</p>
            </div>
            <div class="card-body">
                <!-- Create Test Account Form -->
                <form id="createTestForm" class="admin-form">
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="testRole">ğŸ¯ Role *</label>
                            <select id="testRole" class="form-control" required>
                                <option value="">Select Role</option>
                                <option value="public_viewer">ğŸ‘ï¸ Public Viewer</option>
                                <option value="investigator">ğŸ•µï¸ Investigator</option>
                                <option value="forensic_analyst">ğŸ”¬ Forensic Analyst</option>
                                <option value="legal_professional">âš–ï¸ Legal Professional</option>
                                <option value="court_official">ğŸ›ï¸ Court Official</option>
                                <option value="evidence_manager">ğŸ“‹ Evidence Manager</option>
                                <option value="auditor">ğŸ” Auditor</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="testAccountName">ğŸ“ Account Name *</label>
                            <input type="text" id="testAccountName" class="form-control" 
                                   placeholder="e.g., Test Investigator" required>
                        </div>
                    </div>
                    <div class="form-actions">
                        <button type="submit" class="btn btn-success">
                            ğŸ§ª Create Test Account
                        </button>
                    </div>
                </form>

                <!-- Test Accounts List -->
                <div id="testAccountsList">
                    <h3>ğŸ“‹ Your Test Accounts</h3>
                    <div id="testAccountsContainer">
                        <p class="text-muted">Loading test accounts...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- User Management Section -->
        <div class="admin-section card">
            <div class="card-header">
                <h2>ğŸ‘¥ User Management</h2>
                <p>View and manage all system users</p>
            </div>
            <div class="card-body">
                <div class="mb-4">
                    <button class="btn btn-outline" onclick="loadAllUsers()">ğŸ”„ Refresh Users</button>
                    <span id="userCount" class="ml-4 text-muted">Loading...</span>
                </div>
                
                <div class="table-container">
                    <table class="user-table">
                        <thead>
                            <tr>
                                <th>Wallet Address</th>
                                <th>Name</th>
                                <th>Role</th>
                                <th>Type</th>
                                <th>Status</th>
                                <th>Created</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="usersTableBody">
                            <tr>
                                <td colspan="7" class="text-center">Loading users...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/web3@1.8.0/dist/web3.min.js"></script>
    <script src="config.js?v=3"></script>
    <script src="storage.js?v=3"></script>
    <script>
        let currentAdmin = null;

        // Initialize admin dashboard
        document.addEventListener('DOMContentLoaded', async function() {
            await checkAdminAuth();
            await loadAllUsers();
            await loadTestAccounts();
            initializeEventListeners();
        });

        async function checkAdminAuth() {
            const currentUser = localStorage.getItem('currentUser');
            if (!currentUser) {
                window.location.href = 'index.html';
                return;
            }

            try {
                const user = await storage.getUser(currentUser);
                if (!user || user.role !== 'admin') {
                    alert('Access denied. Administrator privileges required.');
                    window.location.href = 'index.html';
                    return;
                }

                currentAdmin = currentUser;
                document.getElementById('adminWallet').textContent = currentUser.substring(0, 8) + '...';
            } catch (error) {
                console.error('Auth check error:', error);
                window.location.href = 'index.html';
            }
        }

        function initializeEventListeners() {
            document.getElementById('createAdminForm').addEventListener('submit', handleCreateAdmin);
            document.getElementById('createTestForm').addEventListener('submit', handleCreateTestAccount);
        }

        async function handleCreateAdmin(event) {
            event.preventDefault();
            
            try {
                const walletAddress = document.getElementById('adminWalletAddress').value.trim();
                const fullName = document.getElementById('adminFullName').value.trim();

                if (!walletAddress.match(/^0x[a-fA-F0-9]{40}$/)) {
                    throw new Error('Invalid wallet address format');
                }

                await storage.createAdminUser(currentAdmin, {
                    walletAddress,
                    fullName
                });

                showAlert('Administrator created successfully!', 'success');
                document.getElementById('createAdminForm').reset();
                await loadAllUsers();
            } catch (error) {
                showAlert('Error creating admin: ' + error.message, 'error');
            }
        }

        async function handleCreateTestAccount(event) {
            event.preventDefault();
            
            try {
                const role = document.getElementById('testRole').value;
                const accountName = document.getElementById('testAccountName').value.trim();

                const result = await storage.createTestAccount(currentAdmin, {
                    role,
                    accountName
                });

                if (result.success) {
                    showAlert(`Test account created! Wallet: ${result.testWallet}`, 'success');
                    document.getElementById('createTestForm').reset();
                    await loadTestAccounts();
                } else {
                    throw new Error('Failed to create test account');
                }
            } catch (error) {
                showAlert('Error creating test account: ' + error.message, 'error');
            }
        }

        async function loadAllUsers() {
            try {
                const users = await storage.getAllUsers();
                const tbody = document.getElementById('usersTableBody');
                const userCount = document.getElementById('userCount');

                userCount.textContent = `Total Users: ${users.length}`;

                if (users.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="7" class="text-center">No users found</td></tr>';
                    return;
                }

                tbody.innerHTML = users.map(user => `
                    <tr class="${user.account_type === 'test' ? 'test-account' : ''} ${!user.is_active ? 'inactive-user' : ''}">
                        <td class="test-wallet">${user.wallet_address}</td>
                        <td>${user.full_name}</td>
                        <td><span class="badge badge-${getRoleClass(user.role)}">${formatRole(user.role)}</span></td>
                        <td>${user.account_type === 'test' ? 'ğŸ§ª Test' : 'ğŸ‘¤ Real'}</td>
                        <td>${user.is_active ? 'âœ… Active' : 'âŒ Inactive'}</td>
                        <td>${new Date(user.created_at).toLocaleDateString()}</td>
                        <td>
                            ${user.is_active && user.wallet_address !== currentAdmin ? 
                                `<button class="btn btn-sm btn-danger" onclick="deleteUser('${user.wallet_address}')">ğŸ—‘ï¸ Delete</button>` : 
                                user.wallet_address === currentAdmin ? '<span class="text-muted">Self</span>' : '<span class="text-muted">Deleted</span>'
                            }
                        </td>
                    </tr>
                `).join('');
            } catch (error) {
                console.error('Error loading users:', error);
                showAlert('Error loading users', 'error');
            }
        }

        async function loadTestAccounts() {
            try {
                const testAccounts = await storage.getTestAccounts(currentAdmin);
                const container = document.getElementById('testAccountsContainer');

                if (testAccounts.length === 0) {
                    container.innerHTML = '<p class="text-muted">No test accounts created yet.</p>';
                    return;
                }

                container.innerHTML = testAccounts.map(account => `
                    <div class="card mb-3">
                        <div class="card-body">
                            <div class="flex justify-between items-center">
                                <div>
                                    <h4>${account.full_name}</h4>
                                    <p><strong>Role:</strong> <span class="badge badge-${getRoleClass(account.role)}">${formatRole(account.role)}</span></p>
                                    <p><strong>Wallet:</strong> <code class="test-wallet">${account.wallet_address}</code>
                                        <button class="btn btn-sm btn-outline copy-btn" onclick="copyToClipboard('${account.wallet_address}')">ğŸ“‹ Copy</button>
                                    </p>
                                    <p><strong>Created:</strong> ${new Date(account.created_at).toLocaleString()}</p>
                                </div>
                                <div>
                                    <button class="btn btn-sm btn-danger" onclick="deleteTestAccount('${account.wallet_address}')">ğŸ—‘ï¸ Delete</button>
                                </div>
                            </div>
                        </div>
                    </div>
                `).join('');
            } catch (error) {
                console.error('Error loading test accounts:', error);
            }
        }

        async function deleteUser(walletAddress) {
            if (!confirm('Are you sure you want to delete this user? This action will deactivate their account.')) {
                return;
            }

            try {
                await storage.deleteUser(currentAdmin, walletAddress);
                showAlert('User deleted successfully', 'success');
                await loadAllUsers();
            } catch (error) {
                showAlert('Error deleting user: ' + error.message, 'error');
            }
        }

        async function deleteTestAccount(testWallet) {
            if (!confirm('Delete this test account?')) return;

            try {
                await storage.deleteTestAccount(currentAdmin, testWallet);
                showAlert('Test account deleted', 'success');
                await loadTestAccounts();
            } catch (error) {
                showAlert('Error deleting test account: ' + error.message, 'error');
            }
        }

        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                showAlert('Wallet address copied to clipboard!', 'success');
            });
        }

        function formatRole(role) {
            return role.split('_').map(word => word.charAt(0).toUpperCase() + word.slice(1)).join(' ');
        }

        function getRoleClass(role) {
            const classes = {
                'public_viewer': 'public', 'investigator': 'investigator', 'forensic_analyst': 'forensic',
                'legal_professional': 'legal', 'court_official': 'court', 'evidence_manager': 'manager',
                'auditor': 'auditor', 'admin': 'admin'
            };
            return classes[role] || 'public';
        }

        function showAlert(message, type) {
            const alert = document.createElement('div');
            alert.className = `alert alert-${type}`;
            alert.innerHTML = message;
            alert.style.cssText = `
                position: fixed; top: 20px; right: 20px; z-index: 1000;
                padding: 12px 20px; border-radius: 8px; color: white; font-weight: 500;
                max-width: 400px; background: ${type === 'success' ? '#28a745' : '#dc3545'};
            `;
            document.body.appendChild(alert);
            setTimeout(() => alert.remove(), 5000);
        }

        function logout() {
            localStorage.removeItem('currentUser');
            window.location.href = 'index.html';
        }
    </script>
</body>
</html>