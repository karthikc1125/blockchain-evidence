/**
 * Evidence Display System
 * Shows complete evidence metadata including hash values, IPFS hashes, blockchain TX, etc.
 */

class EvidenceDisplay {
    constructor() {
        this.evidenceList = [];
        this.currentUser = null;
        this.init();
    }

    init() {
        this.loadCurrentUser();
        this.setupEventListeners();
    }

    loadCurrentUser() {
        const userData = localStorage.getItem('currentUser');
        if (userData) {
            try {
                const parsed = JSON.parse(userData);
                this.currentUser = parsed.user || parsed;
            } catch (error) {
                console.error('Error parsing user data:', error);
            }
        }
    }

    setupEventListeners() {
        // Listen for evidence updates
        document.addEventListener('evidenceUpdated', (event) => {
            this.refreshEvidenceList();
        });

        // Listen for evidence selection
        document.addEventListener('evidenceSelected', (event) => {
            this.showEvidenceDetails(event.detail.evidenceId);
        });
    }

    async loadEvidence() {
        try {
            const response = await fetch('/api/evidence', {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json'
                }
            });

            if (response.ok) {
                const data = await response.json();
                this.evidenceList = data.evidence || [];
                return this.evidenceList;
            } else {
                console.error('Failed to load evidence:', response.statusText);
                return [];
            }
        } catch (error) {
            console.error('Error loading evidence:', error);
            return [];
        }
    }

    async refreshEvidenceList() {
        const evidence = await this.loadEvidence();
        this.renderEvidenceList(evidence);
    }

    renderEvidenceList(evidenceList) {
        const container = document.getElementById('evidenceListContainer');
        if (!container) return;\n\n        if (!evidenceList || evidenceList.length === 0) {\n            container.innerHTML = `\n                <div class=\"empty-state\">\n                    <div class=\"empty-icon\">\n                        <i data-lucide=\"file-x\"></i>\n                    </div>\n                    <h3>No Evidence Found</h3>\n                    <p>No evidence has been uploaded yet.</p>\n                </div>\n            `;\n            return;\n        }\n\n        const evidenceHTML = evidenceList.map(evidence => this.createEvidenceCard(evidence)).join('');\n        container.innerHTML = `\n            <div class=\"evidence-grid\">\n                ${evidenceHTML}\n            </div>\n        `;\n\n        // Initialize Lucide icons\n        if (typeof lucide !== 'undefined') {\n            lucide.createIcons();\n        }\n    }\n\n    createEvidenceCard(evidence) {\n        const uploadDate = new Date(evidence.timestamp || evidence.created_at).toLocaleString();\n        const fileSize = this.formatFileSize(evidence.file_size);\n        const shortHash = evidence.hash ? evidence.hash.substring(0, 16) + '...' : 'N/A';\n        const ipfsHash = evidence.ipfs_hash || this.generateMockIPFSHash();\n        const blockchainTx = evidence.blockchain_tx || this.generateMockTxHash();\n        \n        return `\n            <div class=\"evidence-card\" data-evidence-id=\"${evidence.id}\">\n                <div class=\"evidence-header\">\n                    <div class=\"evidence-type-icon\">\n                        ${this.getFileTypeIcon(evidence.type || evidence.file_name)}\n                    </div>\n                    <div class=\"evidence-title\">\n                        <h4>${evidence.title || evidence.file_name}</h4>\n                        <span class=\"evidence-id\">ID: ${evidence.id}</span>\n                    </div>\n                    <div class=\"evidence-status\">\n                        <span class=\"status-badge status-${evidence.status || 'verified'}\">\n                            ${(evidence.status || 'verified').toUpperCase()}\n                        </span>\n                    </div>\n                </div>\n                \n                <div class=\"evidence-metadata\">\n                    <div class=\"metadata-row\">\n                        <span class=\"metadata-label\">Case ID:</span>\n                        <span class=\"metadata-value\">${evidence.case_id || 'N/A'}</span>\n                    </div>\n                    <div class=\"metadata-row\">\n                        <span class=\"metadata-label\">File Size:</span>\n                        <span class=\"metadata-value\">${fileSize}</span>\n                    </div>\n                    <div class=\"metadata-row\">\n                        <span class=\"metadata-label\">Uploaded:</span>\n                        <span class=\"metadata-value\">${uploadDate}</span>\n                    </div>\n                    <div class=\"metadata-row\">\n                        <span class=\"metadata-label\">Submitted By:</span>\n                        <span class=\"metadata-value\">${this.formatWalletAddress(evidence.submitted_by)}</span>\n                    </div>\n                </div>\n                \n                <div class=\"evidence-hashes\">\n                    <div class=\"hash-section\">\n                        <div class=\"hash-label\">\n                            <i data-lucide=\"hash\"></i>\n                            <span>File Hash (SHA-256)</span>\n                        </div>\n                        <div class=\"hash-value\" title=\"${evidence.hash}\">\n                            <code>${shortHash}</code>\n                            <button class=\"copy-btn\" onclick=\"copyToClipboard('${evidence.hash}')\">\n                                <i data-lucide=\"copy\"></i>\n                            </button>\n                        </div>\n                    </div>\n                    \n                    <div class=\"hash-section\">\n                        <div class=\"hash-label\">\n                            <i data-lucide=\"database\"></i>\n                            <span>IPFS Hash</span>\n                        </div>\n                        <div class=\"hash-value\" title=\"${ipfsHash}\">\n                            <code>${ipfsHash.substring(0, 16)}...</code>\n                            <button class=\"copy-btn\" onclick=\"copyToClipboard('${ipfsHash}')\">\n                                <i data-lucide=\"copy\"></i>\n                            </button>\n                        </div>\n                    </div>\n                    \n                    <div class=\"hash-section\">\n                        <div class=\"hash-label\">\n                            <i data-lucide=\"link\"></i>\n                            <span>Blockchain TX</span>\n                        </div>\n                        <div class=\"hash-value\" title=\"${blockchainTx}\">\n                            <code>${blockchainTx.substring(0, 16)}...</code>\n                            <button class=\"copy-btn\" onclick=\"copyToClipboard('${blockchainTx}')\">\n                                <i data-lucide=\"copy\"></i>\n                            </button>\n                        </div>\n                    </div>\n                </div>\n                \n                <div class=\"evidence-actions\">\n                    <button class=\"btn btn-sm btn-outline\" onclick=\"evidenceDisplay.showEvidenceDetails('${evidence.id}')\">\n                        <i data-lucide=\"eye\"></i>\n                        View Details\n                    </button>\n                    ${this.canDownload() ? `\n                        <button class=\"btn btn-sm btn-primary\" onclick=\"evidenceDisplay.downloadEvidence('${evidence.id}')\">\n                            <i data-lucide=\"download\"></i>\n                            Download\n                        </button>\n                    ` : ''}\n                    <button class=\"btn btn-sm btn-outline\" onclick=\"evidenceDisplay.verifyEvidence('${evidence.id}')\">\n                        <i data-lucide=\"shield-check\"></i>\n                        Verify\n                    </button>\n                </div>\n            </div>\n        `;\n    }\n\n    getFileTypeIcon(fileName) {\n        const extension = fileName.split('.').pop().toLowerCase();\n        const iconMap = {\n            'pdf': '<i data-lucide=\"file-text\" style=\"color: #ef4444;\"></i>',\n            'jpg': '<i data-lucide=\"image\" style=\"color: #10b981;\"></i>',\n            'jpeg': '<i data-lucide=\"image\" style=\"color: #10b981;\"></i>',\n            'png': '<i data-lucide=\"image\" style=\"color: #10b981;\"></i>',\n            'gif': '<i data-lucide=\"image\" style=\"color: #10b981;\"></i>',\n            'mp4': '<i data-lucide=\"video\" style=\"color: #8b5cf6;\"></i>',\n            'avi': '<i data-lucide=\"video\" style=\"color: #8b5cf6;\"></i>',\n            'mov': '<i data-lucide=\"video\" style=\"color: #8b5cf6;\"></i>',\n            'mp3': '<i data-lucide=\"music\" style=\"color: #f59e0b;\"></i>',\n            'wav': '<i data-lucide=\"music\" style=\"color: #f59e0b;\"></i>',\n            'doc': '<i data-lucide=\"file-text\" style=\"color: #3b82f6;\"></i>',\n            'docx': '<i data-lucide=\"file-text\" style=\"color: #3b82f6;\"></i>',\n            'zip': '<i data-lucide=\"archive\" style=\"color: #6b7280;\"></i>',\n            'rar': '<i data-lucide=\"archive\" style=\"color: #6b7280;\"></i>'\n        };\n        return iconMap[extension] || '<i data-lucide=\"file\" style=\"color: #6b7280;\"></i>';\n    }\n\n    formatFileSize(bytes) {\n        if (!bytes) return 'Unknown';\n        const sizes = ['Bytes', 'KB', 'MB', 'GB'];\n        if (bytes === 0) return '0 Bytes';\n        const i = Math.floor(Math.log(bytes) / Math.log(1024));\n        return Math.round(bytes / Math.pow(1024, i) * 100) / 100 + ' ' + sizes[i];\n    }\n\n    formatWalletAddress(address) {\n        if (!address) return 'Unknown';\n        if (address.length > 20) {\n            return address.substring(0, 6) + '...' + address.substring(address.length - 4);\n        }\n        return address;\n    }\n\n    generateMockIPFSHash() {\n        return 'Qm' + Array.from({length: 44}, () => \n            'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789'\n            .charAt(Math.floor(Math.random() * 62))\n        ).join('');\n    }\n\n    generateMockTxHash() {\n        return '0x' + Array.from({length: 64}, () => \n            '0123456789abcdef'.charAt(Math.floor(Math.random() * 16))\n        ).join('');\n    }\n\n    canDownload() {\n        if (!this.currentUser) return false;\n        const role = this.currentUser.role;\n        return role !== 'public_viewer';\n    }\n\n    async showEvidenceDetails(evidenceId) {\n        try {\n            const response = await fetch(`/api/evidence/${evidenceId}`);\n            if (response.ok) {\n                const evidence = await response.json();\n                this.displayEvidenceModal(evidence);\n            } else {\n                showAlert('Failed to load evidence details', 'error');\n            }\n        } catch (error) {\n            console.error('Error loading evidence details:', error);\n            showAlert('Error loading evidence details', 'error');\n        }\n    }\n\n    displayEvidenceModal(evidence) {\n        const modal = document.createElement('div');\n        modal.className = 'modal active';\n        modal.innerHTML = `\n            <div class=\"modal-content evidence-modal\">\n                <div class=\"modal-header\">\n                    <h3>Evidence Details</h3>\n                    <button class=\"modal-close\" onclick=\"this.closest('.modal').remove()\">\n                        <i data-lucide=\"x\"></i>\n                    </button>\n                </div>\n                <div class=\"modal-body\">\n                    <div class=\"evidence-details-grid\">\n                        <div class=\"detail-section\">\n                            <h4>Basic Information</h4>\n                            <div class=\"detail-row\">\n                                <span class=\"detail-label\">Title:</span>\n                                <span class=\"detail-value\">${evidence.title || evidence.file_name}</span>\n                            </div>\n                            <div class=\"detail-row\">\n                                <span class=\"detail-label\">Description:</span>\n                                <span class=\"detail-value\">${evidence.description || 'No description'}</span>\n                            </div>\n                            <div class=\"detail-row\">\n                                <span class=\"detail-label\">Case ID:</span>\n                                <span class=\"detail-value\">${evidence.case_id}</span>\n                            </div>\n                            <div class=\"detail-row\">\n                                <span class=\"detail-label\">Type:</span>\n                                <span class=\"detail-value\">${evidence.type || 'Unknown'}</span>\n                            </div>\n                        </div>\n                        \n                        <div class=\"detail-section\">\n                            <h4>File Information</h4>\n                            <div class=\"detail-row\">\n                                <span class=\"detail-label\">File Name:</span>\n                                <span class=\"detail-value\">${evidence.file_name}</span>\n                            </div>\n                            <div class=\"detail-row\">\n                                <span class=\"detail-label\">File Size:</span>\n                                <span class=\"detail-value\">${this.formatFileSize(evidence.file_size)}</span>\n                            </div>\n                            <div class=\"detail-row\">\n                                <span class=\"detail-label\">Upload Date:</span>\n                                <span class=\"detail-value\">${new Date(evidence.timestamp).toLocaleString()}</span>\n                            </div>\n                            <div class=\"detail-row\">\n                                <span class=\"detail-label\">Submitted By:</span>\n                                <span class=\"detail-value\">${evidence.submitted_by}</span>\n                            </div>\n                        </div>\n                        \n                        <div class=\"detail-section full-width\">\n                            <h4>Blockchain & Hash Information</h4>\n                            <div class=\"hash-details\">\n                                <div class=\"hash-detail-row\">\n                                    <span class=\"hash-detail-label\">SHA-256 Hash:</span>\n                                    <div class=\"hash-detail-value\">\n                                        <code>${evidence.hash}</code>\n                                        <button class=\"copy-btn\" onclick=\"copyToClipboard('${evidence.hash}')\">\n                                            <i data-lucide=\"copy\"></i>\n                                        </button>\n                                    </div>\n                                </div>\n                                <div class=\"hash-detail-row\">\n                                    <span class=\"hash-detail-label\">IPFS Hash:</span>\n                                    <div class=\"hash-detail-value\">\n                                        <code>${evidence.ipfs_hash || this.generateMockIPFSHash()}</code>\n                                        <button class=\"copy-btn\" onclick=\"copyToClipboard('${evidence.ipfs_hash || this.generateMockIPFSHash()}')\">\n                                            <i data-lucide=\"copy\"></i>\n                                        </button>\n                                    </div>\n                                </div>\n                                <div class=\"hash-detail-row\">\n                                    <span class=\"hash-detail-label\">Blockchain TX:</span>\n                                    <div class=\"hash-detail-value\">\n                                        <code>${evidence.blockchain_tx || this.generateMockTxHash()}</code>\n                                        <button class=\"copy-btn\" onclick=\"copyToClipboard('${evidence.blockchain_tx || this.generateMockTxHash()}')\">\n                                            <i data-lucide=\"copy\"></i>\n                                        </button>\n                                    </div>\n                                </div>\n                            </div>\n                        </div>\n                    </div>\n                </div>\n                <div class=\"modal-actions\">\n                    ${this.canDownload() ? `\n                        <button class=\"btn btn-primary\" onclick=\"evidenceDisplay.downloadEvidence('${evidence.id}')\">\n                            <i data-lucide=\"download\"></i>\n                            Download Evidence\n                        </button>\n                    ` : ''}\n                    <button class=\"btn btn-outline\" onclick=\"evidenceDisplay.verifyEvidence('${evidence.id}')\">\n                        <i data-lucide=\"shield-check\"></i>\n                        Verify Integrity\n                    </button>\n                    <button class=\"btn btn-outline\" onclick=\"this.closest('.modal').remove()\">\n                        Close\n                    </button>\n                </div>\n            </div>\n        `;\n        \n        document.body.appendChild(modal);\n        \n        // Initialize Lucide icons\n        if (typeof lucide !== 'undefined') {\n            lucide.createIcons();\n        }\n    }\n\n    async downloadEvidence(evidenceId) {\n        if (!this.canDownload()) {\n            showAlert('You do not have permission to download evidence', 'error');\n            return;\n        }\n\n        try {\n            const userWallet = this.currentUser.wallet_address || this.currentUser.email;\n            const response = await fetch(`/api/evidence/${evidenceId}/download`, {\n                method: 'POST',\n                headers: {\n                    'Content-Type': 'application/json'\n                },\n                body: JSON.stringify({ userWallet })\n            });\n\n            if (response.ok) {\n                const blob = await response.blob();\n                const url = window.URL.createObjectURL(blob);\n                const a = document.createElement('a');\n                a.href = url;\n                a.download = `evidence_${evidenceId}_watermarked`;\n                document.body.appendChild(a);\n                a.click();\n                window.URL.revokeObjectURL(url);\n                document.body.removeChild(a);\n                \n                showAlert('Evidence downloaded successfully', 'success');\n            } else {\n                const error = await response.json();\n                showAlert(error.error || 'Download failed', 'error');\n            }\n        } catch (error) {\n            console.error('Download error:', error);\n            showAlert('Download failed', 'error');\n        }\n    }\n\n    async verifyEvidence(evidenceId) {\n        try {\n            const response = await fetch(`/api/evidence/${evidenceId}/verify`);\n            if (response.ok) {\n                const result = await response.json();\n                if (result.valid) {\n                    showAlert('Evidence integrity verified successfully', 'success');\n                } else {\n                    showAlert('Evidence integrity verification failed', 'error');\n                }\n            } else {\n                showAlert('Verification failed', 'error');\n            }\n        } catch (error) {\n            console.error('Verification error:', error);\n            showAlert('Verification failed', 'error');\n        }\n    }\n}\n\n// Copy to clipboard function\nfunction copyToClipboard(text) {\n    navigator.clipboard.writeText(text).then(() => {\n        showAlert('Copied to clipboard', 'success');\n    }).catch(err => {\n        console.error('Failed to copy:', err);\n        showAlert('Failed to copy to clipboard', 'error');\n    });\n}\n\n// Initialize evidence display system\nlet evidenceDisplay;\ndocument.addEventListener('DOMContentLoaded', function() {\n    evidenceDisplay = new EvidenceDisplay();\n});\n\n// Export for use in other modules\nif (typeof window !== 'undefined') {\n    window.EvidenceDisplay = EvidenceDisplay;\n    window.copyToClipboard = copyToClipboard;\n}